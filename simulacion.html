<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemelo Digital: Sistema de Riego Inteligente</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px;
        }
        
        .dashboard { 
            background: white; 
            padding: 2.5rem; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            width: 100%;
            max-width: 500px;
            position: relative; /* Necesario para el overlay */
            overflow: hidden;   /* Para que el overlay respete los bordes redondos */
        }
        
        h1 { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 25px; 
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* --- OVERLAY DE CONGELADO (NUEVO) --- */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none; /* Oculto por defecto */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        .overlay h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .overlay p {
            color: #666;
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        .btn-exit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s;
        }

        .btn-exit:hover {
            transform: scale(1.05);
        }
        /* ----------------------------------- */

        /* Botones de Control */
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-demo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-demo:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-demo:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        /* Estado de Demo */
        .demo-status {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Controles Manuales */
        .control-group { 
            margin-bottom: 25px; 
            background: #f8f9fa; 
            padding: 18px; 
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .control-group:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .control-group.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        label { 
            display: block; 
            margin-bottom: 12px; 
            font-weight: 600; 
            color: #495057;
            font-size: 0.95rem;
        }
        
        input[type=range] { 
            width: 100%; 
            cursor: pointer;
            height: 8px;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
            background: linear-gradient(to right, #667eea 0%, #764ba2 100%);
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .value-display { 
            float: right; 
            font-weight: bold; 
            color: #667eea;
            font-size: 1.1rem;
        }

        .volt-display {
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #495057;
            display: flex;
            justify-content: space-between;
        }

        /* Toggle Switch */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input { opacity: 0; width: 0; height: 0; }
        
        .slider-toggle {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider-toggle:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider-toggle { background-color: #28a745; }
        input:checked + .slider-toggle:before { transform: translateX(24px); }

        /* Visualizadores */
        .gauge-container { 
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        
        .bar-bg { 
            background: #e9ecef; 
            height: 25px; 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .bar-fill { 
            height: 100%; 
            width: 0%; 
            transition: width 0.1s linear, background-color 0.5s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .rpm-bar { background: linear-gradient(90deg, #28a745, #20c997); }
        .temp-bar { background: linear-gradient(90deg, #ffc107, #fd7e14); }
        .cool-bar { background: linear-gradient(90deg, #17a2b8, #00d4ff); }

        .status-text { 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.9rem; 
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        /* Motor Animado */
        .motor-visual { 
            display: flex; 
            flex-direction: column;
            align-items: center;
            margin: 25px 0; 
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
        }
        
        .motor-container {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .fan { 
            width: 100%;
            height: 100%;
            position: absolute;
            background: radial-gradient(circle, #34495e 20%, #2c3e50 100%);
            border-radius: 50%;
            transition: transform 0.05s linear;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .fan::before, .fan::after {
            content: '';
            position: absolute;
            background: #3498db;
            border-radius: 5px;
        }

        .fan::before { width: 80%; height: 15%; top: 42.5%; left: 10%; }
        .fan::after { width: 15%; height: 80%; top: 10%; left: 42.5%; }

        .motor-center {
            position: absolute;
            width: 30%;
            height: 30%;
            background: #95a5a6;
            border-radius: 50%;
            top: 35%;
            left: 35%;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .motor-label {
            margin-top: 15px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        /* Alertas */
        .alert-box { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white; 
            padding: 15px; 
            border-radius: 10px; 
            text-align: center; 
            font-weight: bold; 
            display: none;
            margin-bottom: 20px;
            animation: pulse 1s infinite;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        @keyframes pulse { 
            0%, 100% { transform: scale(1); opacity: 1; } 
            50% { transform: scale(1.02); opacity: 0.9; } 
        }
        
        .countdown {
            font-size: 1.5rem;
            margin-top: 5px;
        }

        /* Indicadores de Estado */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
            animation: blink 1s infinite;
        }

        .status-running { background: #28a745; }
        .status-cooling { background: #17a2b8; }
        .status-critical { background: #dc3545; }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .dashboard { padding: 1.5rem; }
            h1 { font-size: 1.4rem; }
            .button-group { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="dashboard">
    <h1>
        <span>üíß</span> Sistema de Riego Inteligente
    </h1>

    <div class="button-group">
        <button id="demoBtn" class="btn btn-demo">
            <span>‚ñ∂Ô∏è</span> Iniciar Demo
        </button>
        <button id="resetBtn" class="btn btn-reset">
            <span>üîÑ</span> Resetear
        </button>
    </div>

    <div id="demoStatus" class="demo-status">
        <div id="demoMessage">Preparando demostraci√≥n...</div>
    </div>

    <div id="demoEndOverlay" class="overlay">
        <h2>‚ú® Demo Completada</h2>
        <p>El sistema ha alcanzado el 100% de humedad.</p>
        <p style="font-size: 0.9rem; margin-top:-15px;">(Valores congelados para an√°lisis)</p>
        <button id="exitDemoBtn" class="btn-exit">Volver al Panel</button>
    </div>

    <div id="manualControl" class="control-group">
        <label>
            üå± Humedad del Suelo (%): 
            <span id="humVal" class="value-display">50%</span>
        </label>
        <input type="range" id="humSlider" min="0" max="100" value="50">
        <div class="volt-display">
            <span>‚ö° Voltaje Control (u):</span>
            <span id="voltVal" style="color: #667eea; font-weight: bold;">2.5 V</span>
        </div>

        <div class="toggle-row">
            <span style="font-weight:600; color:#495057; font-size:0.95rem;">üõ°Ô∏è Protecci√≥n T√©rmica (80¬∞C)</span>
            <label class="switch">
                <input type="checkbox" id="protToggle" checked>
                <span class="slider-toggle"></span>
            </label>
        </div>
    </div>

    <div id="safetyAlert" class="alert-box">
        <div>üö® PROTECCI√ìN T√âRMICA ACTIVA üö®</div>
        <div>Sistema en enfriamiento...</div>
        <div class="countdown" id="cooldownTimer"></div>
    </div>

    <div class="motor-visual">
        <div class="motor-container">
            <div id="fanBlade" class="fan"></div>
            <div class="motor-center"></div>
        </div>
        <div class="motor-label">
            <span id="motorStatus" class="status-indicator"></span>
            <span id="motorStatusText">Motor Detenido</span>
        </div>
    </div>

    <div class="gauge-container">
        <div class="status-text">
            <span>‚öôÔ∏è RPM Motor (x‚ÇÅ)</span> 
            <span id="rpmText" style="color: #28a745;">0 RPM</span>
        </div>
        <div class="bar-bg">
            <div id="rpmBar" class="bar-fill rpm-bar"></div>
        </div>
    </div>

    <div class="gauge-container">
        <div class="status-text">
            <span>üå°Ô∏è Temperatura (x‚ÇÇ)</span> 
            <span id="tempText" style="color: #ffc107;">20¬∞C</span>
        </div>
        <div class="bar-bg">
            <div id="tempBar" class="bar-fill temp-bar"></div>
        </div>
    </div>

    <div class="gauge-container">
        <div class="status-text">
            <span>Humedad de los ultimos dias</span>
        </div>
        <canvas id="thingspeakChart" width="400" height="180"></canvas>
        <button id="addChartBtn" style="margin-top:15px;padding:8px 16px;border-radius:8px;border:none;background:#667eea;color:white;font-weight:bold;cursor:pointer;">
            ‚ûï Agregar gr√°fico de ThingSpeak
        </button>
        <div id="extraCharts"></div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // === PAR√ÅMETROS F√çSICOS ===
    const alpha = 0.5;
    const beta = 20.0;
    const k1 = 0.08;   // Generaci√≥n de calor
    const k2 = 0.03;   // Refrigeraci√≥n por agua
    const gamma = 0.05; // Disipaci√≥n al ambiente
    const dt = 0.1;    // Paso de tiempo (100ms)

    // Variables de Estado
    let x_rpm = 0;
    let x_temp = 20;
    
    // Configuraci√≥n de Seguridad
    const TEMP_AMB = 20;
    const TEMP_CRITICA = 80;
    const TEMP_REINICIO = 60;
    const RPM_MAX = 200;
    const TIEMPO_ESPERA = 3000;

    // Estado del Sistema
    let en_enfriamiento = false;
    let tiempo_inicio_corte = 0;
    let rotation = 0;
    let demoRunning = false;
    let demoStep = 0;
    let protectionEnabled = true;
    
    // NUEVA VARIABLE: Para congelar la f√≠sica
    let simulationPaused = false; 

    // Elementos del DOM
    const slider = document.getElementById('humSlider');
    const humVal = document.getElementById('humVal');
    const voltVal = document.getElementById('voltVal');
    const rpmBar = document.getElementById('rpmBar');
    const tempBar = document.getElementById('tempBar');
    const rpmText = document.getElementById('rpmText');
    const tempText = document.getElementById('tempText');
    const fanBlade = document.getElementById('fanBlade');
    const safetyAlert = document.getElementById('safetyAlert');
    const cooldownTimer = document.getElementById('cooldownTimer');
    const demoBtn = document.getElementById('demoBtn');
    const resetBtn = document.getElementById('resetBtn');
    const demoStatus = document.getElementById('demoStatus');
    const demoMessage = document.getElementById('demoMessage');
    const manualControl = document.getElementById('manualControl');
    const motorStatus = document.getElementById('motorStatus');
    const motorStatusText = document.getElementById('motorStatusText');
    const protToggle = document.getElementById('protToggle');
    const demoEndOverlay = document.getElementById('demoEndOverlay');
    const exitDemoBtn = document.getElementById('exitDemoBtn');

    // === SECUENCIA DE DEMOSTRACI√ìN ===
    // Modificada para terminar en 100%
    const demoSequence = [
        { time: 0,    humedad: 0,  message: "üå± Suelo seco (0%) - M√°xima potencia" },
        { time: 3000, humedad: 25, message: "üíß Humedad subiendo (25%)" },
        { time: 7000, humedad: 50, message: "üíß Riego constante (50%)" },
        { time: 12000, humedad: 80, message: "‚úÖ Casi listo (80%) - Bajando RPM" },
        { time: 16000, humedad: 100, message: "‚ú® Riego Completado (100%)" }
    ];

    // === EVENTOS ===
    demoBtn.addEventListener('click', startDemo);
    resetBtn.addEventListener('click', resetSystem);
    exitDemoBtn.addEventListener('click', exitFrozenDemo); // Nuevo evento
    
    slider.addEventListener('input', () => {
        if (!demoRunning) updateSliderDisplay();
    });

    protToggle.addEventListener('change', (e) => {
        protectionEnabled = e.target.checked;
        if(!protectionEnabled) {
            en_enfriamiento = false;
            safetyAlert.style.display = 'none';
        }
    });

    // === FUNCIONES DE DEMO ===
    function startDemo() {
        if (demoRunning) return;
        
        demoRunning = true;
        demoStep = 0;
        simulationPaused = false; // Asegurar f√≠sica activa
        demoBtn.disabled = true;
        demoBtn.innerHTML = '<span>‚è∏Ô∏è</span> Demo en curso...';
        demoStatus.style.display = 'block';
        slider.disabled = true; // Solo deshabilito slider
        
        resetSystem();
        runDemoSequence();
    }

    function runDemoSequence() {
        if (demoStep >= demoSequence.length) {
            freezeDemo(); // Al terminar, congelamos
            return;
        }

        const step = demoSequence[demoStep];
        
        setTimeout(() => {
            if (!demoRunning) return;
            
            slider.value = step.humedad;
            updateSliderDisplay();
            demoMessage.textContent = step.message;
            
            demoStep++;
            runDemoSequence();
        }, demoStep === 0 ? 0 : demoSequence[demoStep].time - demoSequence[demoStep - 1].time);
    }

    // NUEVA FUNCI√ìN: Congelar
    function freezeDemo() {
        simulationPaused = true; // Detiene el setInterval f√≠sico
        demoEndOverlay.style.display = 'flex'; // Muestra el overlay
        demoStatus.style.display = 'none';
    }

    // NUEVA FUNCI√ìN: Salir del congelado
    function exitFrozenDemo() {
        demoEndOverlay.style.display = 'none';
        demoRunning = false;
        simulationPaused = false; // Reactiva f√≠sica
        
        demoBtn.disabled = false;
        demoBtn.innerHTML = '<span>‚ñ∂Ô∏è</span> Iniciar Demo';
        slider.disabled = false;
    }

    function resetSystem() {
        x_rpm = 0;
        x_temp = 20;
        en_enfriamiento = false;
        rotation = 0;
        slider.value = 50;
        protToggle.checked = true;
        protectionEnabled = true;
        
        // Si reseteamos, quitamos cualquier estado de pausa/overlay
        simulationPaused = false;
        demoEndOverlay.style.display = 'none';
        
        updateSliderDisplay();
        updateUI();
    }

    function updateSliderDisplay() {
        const humedad = parseInt(slider.value);
        humVal.innerText = humedad + "%";
    }

    // BUCLE PRINCIPAL DE SIMULACI√ìN 
    setInterval(() => {
        // Si est√° congelado, NO calculamos nada, retornamos antes.
        if (simulationPaused) return; 

        // 1. Leer Entrada
        let humedad = parseInt(slider.value);
        humVal.innerText = humedad + "%";

        // 2. L√≥gica de Control y Protecci√≥n
        let u = 0;

        if (protectionEnabled && !en_enfriamiento && x_temp >= TEMP_CRITICA) {
            en_enfriamiento = true;
            tiempo_inicio_corte = Date.now();
        }

        if (en_enfriamiento) {
            u = 0;
            safetyAlert.style.display = 'block';
            const tiempoPasado = Date.now() - tiempo_inicio_corte;
            const tiempoRestante = Math.max(0, Math.ceil((TIEMPO_ESPERA - tiempoPasado) / 1000));
            cooldownTimer.textContent = tiempoRestante + "s";

            let dx2 = -gamma * (x_temp - TEMP_AMB);
            x_temp += dx2 * dt;
            if (x_temp < TEMP_AMB) x_temp = TEMP_AMB;
            if (x_temp > 100) x_temp = 100; // Limitar temperatura m√°xima
            x_rpm = 0; 

            if (tiempoPasado > TIEMPO_ESPERA && x_temp < TEMP_REINICIO) {
                en_enfriamiento = false;
                safetyAlert.style.display = 'none';
            }
        } else {
            u = 5.0 * (1.0 - humedad / 100.0);
            u = Math.max(0, Math.min(u, 5.0)); 
            safetyAlert.style.display = 'none';

            let dx1 = -alpha * x_rpm + beta * u;
            let dx2 = (k1 - k2) * x_rpm - gamma * (x_temp - TEMP_AMB);

            x_rpm += dx1 * dt;
            x_temp += dx2 * dt;

            x_rpm = Math.max(0, Math.min(x_rpm, RPM_MAX));
            if (x_temp < TEMP_AMB) x_temp = TEMP_AMB;
            if (x_temp > 100) x_temp = 100; // Limitar temperatura m√°xima
        }

        voltVal.innerText = u.toFixed(2) + " V";

        updateUI();

    }, 130); 

    // ACTUALIZACI√ìN DE INTERFAZ 
    function updateUI() {
        let rpmPct = (x_rpm / RPM_MAX) * 100;
        let visualMaxTemp = protectionEnabled ? 100 : 250;
        let tempPct = Math.min(100, ((x_temp - 20) / (visualMaxTemp - 20)) * 100);
        
        rpmBar.style.width = rpmPct + "%";
        rpmText.innerText = Math.round(x_rpm) + " RPM";

        tempBar.style.width = tempPct + "%";
        tempText.innerText = Math.round(x_temp) + "¬∞C";

        if (x_temp < 60) {
            tempBar.style.background = "linear-gradient(90deg, #ffc107, #ffca2c)";
        } else if (x_temp < 80) {
            tempBar.style.background = "linear-gradient(90deg, #fd7e14, #ff922b)";
        } else {
            tempBar.style.background = "linear-gradient(90deg, #dc3545, #ff1744)";
        }

        if (en_enfriamiento) {
            motorStatus.className = 'status-indicator status-cooling';
            motorStatusText.textContent = 'Sistema en Enfriamiento';
        } else if (x_rpm > 10) {
            motorStatus.className = 'status-indicator status-running';
            motorStatusText.textContent = 'Motor Activo';
        } else {
            motorStatus.className = 'status-indicator';
            motorStatusText.textContent = 'Motor Detenido';
            motorStatus.style.background = '#6c757d';
        }

        if (x_rpm > 1) {
            rotation += x_rpm * 0.15;
            fanBlade.style.transform = `rotate(${rotation}deg)`;
        }
    }

    // THINGSPEAK CHART
    const THINGSPEAK_CHANNEL_ID = '3177048';
    const THINGSPEAK_API_KEY = 'DAZRG8GSL10W5AYJ';
    const THINGSPEAK_URL_BASE = `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/fields/`;

    let thingspeakChart = null;

    function fetchThingSpeakData(field, chartId) {
        const url = `${THINGSPEAK_URL_BASE}${field}.json?api_key=${THINGSPEAK_API_KEY}&results=20`;
        fetch(url)
            .then(res => res.json())
            .then(data => {
                const feeds = data.feeds || [];
                const labels = feeds.map(f => {
                    const d = new Date(f.created_at);
                    return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
                });
                const values = feeds.map(f => parseFloat(f['field' + field]) || 0);
                renderThingSpeakChart(labels, values, chartId, field);
            });
    }

    function renderThingSpeakChart(labels, values, chartId, field) {
        const ctx = document.getElementById(chartId).getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Field ${field}`,
                    data: values,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102,126,234,0.1)',
                    fill: true,
                    tension: 0.2,
                    pointRadius: 2
                }]
            },
            options: {
                scales: {
                    x: { display: true, title: { display: false } },
                    y: { display: true, title: { display: true, text: 'Valor' } }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    fetchThingSpeakData(4, 'thingspeakChart');
    setInterval(() => fetchThingSpeakData(4, 'thingspeakChart'), 60000);

    // NUEVO: Obtener metadata de fields
    let thingspeakFieldsMeta = [];
    function fetchFieldsMeta() {
        fetch(`https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/feeds.json?api_key=${THINGSPEAK_API_KEY}&results=1`)
            .then(res => res.json())
            .then(data => {
                const channel = data.channel || {};
                thingspeakFieldsMeta = [];
                for (let i = 1; i <= 8; i++) {
                    if (channel['field'+i]) {
                        thingspeakFieldsMeta.push({id: i, name: channel['field'+i]});
                    }
                }
            });
    }
    fetchFieldsMeta();

    document.getElementById('addChartBtn').addEventListener('click', () => {
        // NUEVO: Mostrar lista de fields con nombres y copiar
        let fieldList = thingspeakFieldsMeta.map(f =>
            `<div style="margin-bottom:8px;">
                <button style="margin-right:8px;" onclick="copyFieldName('${f.name}')">üìã</button>
                <button style="background:#667eea;color:white;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;" onclick="selectField(${f.id})">
                    Field ${f.id}: ${f.name}
                </button>
            </div>`
        ).join('');
        let dialog = document.createElement('div');
        dialog.style.position = 'fixed';
        dialog.style.top = '0'; dialog.style.left = '0'; dialog.style.width = '100vw'; dialog.style.height = '100vh';
        dialog.style.background = 'rgba(0,0,0,0.3)';
        dialog.style.display = 'flex'; dialog.style.alignItems = 'center'; dialog.style.justifyContent = 'center';
        dialog.innerHTML = `
            <div style="background:white;padding:30px;border-radius:16px;max-width:350px;">
                <h3 style="margin-bottom:15px;">Selecciona un field de ThingSpeak</h3>
                ${fieldList}
                <button onclick="this.parentElement.parentElement.remove()" style="margin-top:10px;background:#dc3545;color:white;border:none;border-radius:6px;padding:6px 16px;cursor:pointer;">Cerrar</button>
            </div>
        `;
        document.body.appendChild(dialog);

        // Funciones globales para copiar y seleccionar
        window.copyFieldName = function(name) {
            navigator.clipboard.writeText(name);
        };
        window.selectField = function(fieldId) {
            dialog.remove();
            const chartContainer = document.createElement('div');
            chartContainer.style.marginTop = '20px';
            chartContainer.style.position = 'relative';
            const fieldMeta = thingspeakFieldsMeta.find(f => f.id === fieldId);
            chartContainer.innerHTML = `
                <button class="removeChartBtn" style="position:absolute;top:5px;right:5px;padding:2px 8px;border-radius:6px;border:none;background:#dc3545;color:white;cursor:pointer;font-size:1rem;">üóëÔ∏è</button>
                <div class="status-text"><span>Field ${fieldId} (${fieldMeta ? fieldMeta.name : 'ThingSpeak'})</span></div>
                <canvas id="thingspeakChart${fieldId}" width="400" height="180"></canvas>
            `;
            document.getElementById('extraCharts').appendChild(chartContainer);
            fetchThingSpeakData(fieldId, `thingspeakChart${fieldId}`);

            chartContainer.querySelector('.removeChartBtn').addEventListener('click', () => {
                chartContainer.remove();
            });
        };
    });

    updateSliderDisplay();
    updateUI();
</script>

</body>
</html>